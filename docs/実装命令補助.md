# 実装命令補助文書

**これは継続的な実装で必ず参照する命令補助文書です**

## 🎯 実装の基本原則

### 最重要方針
- **コードの可読性を最優先**: とにかく分かりやすくシンプルな実装
- **TODOは作らない**: すべて完遂させる（Phase移動は可）  
- **アジャイル開発**: 実装⇒設計書修正⇒実装⇒設計書修正の反復
- **最小構成から開始**: Phase1 MVP → Phase2 → Phase3 の段階的拡張

### 制約事項
- **設計書準拠は必須ではない**: 可読性・シンプルさ優先で適宜変更OK
- **重い実装はPhase2移動**: シンプルに実装できない場合は設計書を修正してPhase2に移動
- **ドキュメント同期必須**: Phase移動時は必ず設計書を更新

## 📋 Phase1 MVP 必須要件

### 技術制約
- **対象カテゴリ**: MVTec bottle のみ
- **UI技術**: Tkinter（シンプル・軽量）
- **AI技術**: anomalib + OpenVINO
- **OS**: Windows 10/11
- **言語**: Python 3.8-3.11

### 機能制約（Phase1）
- **学習**: bottleカテゴリの基本学習のみ
- **推論**: 単一画像ファイルの読み込み→判定のみ
- **UI**: 最小限の操作性（新卒1日習得レベル）
- **ログ**: 基本的な構造化ログのみ

### 品質基準
- **異常検知精度**: > 90%
- **推論速度**: < 1秒/画像
- **学習時間**: < 30分
- **メモリ使用量**: < 4GB (推論)
- **アプリ起動時間**: < 10秒

## 🏗️ 実装順序（厳守）

### Stage 1: 基盤構築（1-2日）
1. **shared/config/config_manager.py** - YAML設定管理
2. **shared/utils/logger.py** - 構造化ログ
3. **shared/domain/*.py** - データモデル定義
4. **shared/utils/file_utils.py, image_utils.py** - ユーティリティ
5. **config/*.yaml** - 設定ファイル

### Stage 2: データ管理（2-3日）
1. **training_app/core/dataset_manager.py** - bottleデータセット管理
2. データセット検証・統計機能
3. エラーハンドリング

### Stage 3: 学習機能（3-4日）
1. **training_app/core/training_manager.py** - anomalib統合
2. **training_app/core/model_manager.py** - モデル保存・OpenVINO変換
3. 学習進捗監視・ログ

### Stage 4: 推論機能（2-3日）
1. **inference_app/core/image_manager.py** - 画像読み込み・前処理
2. **inference_app/core/anomaly_detector.py** - OpenVINO推論エンジン
3. **inference_app/core/result_manager.py** - 結果管理・保存

### Stage 5: GUI（2-3日）
1. **training_app/gui/*.py** - 学習アプリUI
2. **inference_app/gui/*.py** - 推論アプリUI  
3. 統合・エラーハンドリング

### Stage 6: メインアプリ統合（1-2日）
1. **training_app/main.py** - 学習アプリ統合
2. **inference_app/main.py** - 推論アプリ統合
3. E2Eテスト・最終調整

## 💻 実装ガイドライン

### コーディング規約
```python
# 1. クラス名: PascalCase
class DatasetManager:
    pass

# 2. 関数名: snake_case  
def validate_dataset():
    pass

# 3. 定数: UPPER_SNAKE_CASE
MAX_IMAGE_SIZE = 1024

# 4. ログ使用例
logger = setup_logger("module_name")
logger.info("処理開始", extra={"operation": "training"})

# 5. エラーハンドリング
try:
    result = risky_operation()
except SpecificError as e:
    logger.error("エラー発生", extra={"error": str(e)})
    raise UserFriendlyError("分かりやすいメッセージ")
```

### ディレクトリ構造（厳守）
```
anomalib/
├── training_app/           # 学習アプリケーション
│   ├── main.py
│   ├── gui/               # GUI層
│   └── core/              # ビジネスロジック層
├── inference_app/         # 推論アプリケーション  
│   ├── main.py
│   ├── gui/               # GUI層
│   └── core/              # ビジネスロジック層
├── shared/                # 共有モジュール
│   ├── config/            # 設定管理
│   ├── domain/            # ドメインモデル
│   └── utils/             # ユーティリティ
├── config/                # 設定ファイル
├── models/                # 学習済みモデル
├── logs/                  # ログファイル
└── datasets/              # データセット
    └── development/
        └── mvtec/
            └── bottle/    # Phase1対象
```

### エラーハンドリング方針
```python
# カスタム例外の定義
class DatasetValidationError(Exception):
    """データセット検証エラー"""
    
# ユーザー向けメッセージ
def show_user_friendly_error(message: str, details: str = ""):
    """技術用語を避けた分かりやすいエラー表示"""
    
# ログ記録
logger.error("技術的詳細", extra={"details": technical_info})
```

## 🔧 依存関係・環境

### 必須パッケージ
```python
# requirements.txt 
anomalib>=1.0.0
openvino>=2023.0
opencv-python>=4.8.0
numpy>=1.21.0
PyYAML>=6.0
Pillow>=9.0.0
pandas>=1.5.0
matplotlib>=3.6.0
```

### 環境変数
```bash
# 開発環境
ANOMALIB_ENV=development
ANOMALIB_CONFIG_PATH=config/development_config.yaml
```

## 📊 Phase1 完了チェックリスト

### 必須機能チェック
- [ ] bottleカテゴリでの学習完了
- [ ] OpenVINOモデル変換成功
- [ ] 推論アプリで画像判定実行
- [ ] 基本ログ出力機能
- [ ] エラー時の適切なメッセージ表示

### 品質チェック
- [ ] 異常検知精度 > 90%
- [ ] 推論速度 < 1秒/画像
- [ ] 学習時間 < 30分  
- [ ] 8時間連続動作可能
- [ ] 新卒1日で操作習得可能

### 拡張準備チェック
- [ ] Phase2拡張ポイント明確化
- [ ] 設定ベース機能切り替え
- [ ] モジュール間インターフェース安定
- [ ] テストケース整備

## 🚨 重い実装の Phase2 移動基準

以下の条件に該当する場合は **Phase2に移動**:

### 複雑性基準
- 実装に3日以上かかる見込み
- 外部システム連携が必要
- 高度なアルゴリズム・最適化が必要
- デバッグ・トラブルシューティングが困難

### 具体例（Phase2移動対象）
- 複数カテゴリ対応
- バッチ画像処理
- 高度なUI機能（グラフ表示等）
- 詳細統計・レポート機能
- 外部カメラ連携
- 自動ハイパーパラメータ調整

### Phase移動時の手順
1. **設計書更新**: Phase1から該当機能を削除、Phase2に追加
2. **実装優先度見直し**: Phase1の残り機能の優先度再評価
3. **代替実装**: 可能であればPhase1向けの簡易版を実装

## 📝 ドキュメント更新ルール

### 必須更新タイミング
- **Phase移動時**: 必ず設計書の該当箇所を更新
- **実装完了時**: 実装内容と設計の差分があれば更新
- **設計変更時**: 変更理由と影響範囲を記録

### 更新対象ドキュメント
- `docs/Phase1_設計.md` - Phase1詳細設計
- `docs/機能要件.md` - 全体機能要件  
- `docs/実装命令補助.md` - 本文書（必要に応じて）

## 🎯 成功の定義

### Phase1 MVP成功 = 以下の実証
1. **bottleカテゴリで異常検知が動作** - 学習から推論まで一通り実行
2. **新卒1日習得** - シンプルで直感的なUI/操作
3. **品質基準達成** - 精度・速度・安定性の最低基準クリア
4. **Phase2拡張準備** - 明確な拡張ポイントと方針

### 最終目標
**工場現場で実際に使える最小限のAI異常検知システム**の実現

---

**この文書は実装の羅針盤です。迷った時は必ずこの原則に戻ってください。**